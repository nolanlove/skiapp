<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkiSpotter - Find Ski Conditions Near You</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    
    <!-- Custom fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        * {
            font-family: 'Outfit', sans-serif;
        }
        
        .mono {
            font-family: 'JetBrains Mono', monospace;
        }
        
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            min-height: 100vh;
        }
        
        /* Mountain pattern background */
        .hero-bg {
            background: 
                linear-gradient(135deg, rgba(56, 189, 248, 0.1) 0%, transparent 50%),
                linear-gradient(225deg, rgba(129, 140, 248, 0.1) 0%, transparent 50%);
        }
        
        #map {
            height: 500px;
            width: 100%;
            border-radius: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .resort-card {
            transition: all 0.3s ease;
        }
        
        .resort-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px -15px rgba(56, 189, 248, 0.3);
            border-color: rgba(56, 189, 248, 0.5);
        }
        
        .search-input {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.2s ease;
        }
        
        .search-input:focus {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(56, 189, 248, 0.6);
            box-shadow: 0 0 0 4px rgba(56, 189, 248, 0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #38bdf8 0%, #818cf8 100%);
            transition: all 0.2s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px -10px rgba(56, 189, 248, 0.6);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #38bdf8;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .snow-badge {
            background: linear-gradient(135deg, #38bdf8 0%, #818cf8 100%);
        }
        
        .snow-badge.fresh {
            background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
        }
        
        /* Custom Leaflet popup */
        .leaflet-popup-content-wrapper {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            color: white;
        }
        
        .leaflet-popup-tip {
            background: rgba(15, 23, 42, 0.95);
        }
        
        .leaflet-popup-content {
            margin: 0;
        }
        
        /* Gradient text */
        .gradient-text {
            background: linear-gradient(135deg, #38bdf8 0%, #818cf8 50%, #f472b6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Pulse animation for loading */
        .pulse-soft {
            animation: pulse-soft 2s ease-in-out infinite;
        }
        
        @keyframes pulse-soft {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        /* Backup hidden class in case Tailwind CDN is slow */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body class="text-white">
    <div class="hero-bg min-h-screen">
        <!-- Header -->
        <header class="py-6 px-4">
            <div class="max-w-6xl mx-auto flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-400 to-indigo-500 flex items-center justify-center text-xl">
                        ‚õ∑Ô∏è
                    </div>
                    <h1 class="text-2xl font-bold">
                        <span class="gradient-text">SkiSpotter</span>
                    </h1>
                </div>
                <div class="text-slate-400 text-sm hidden sm:block">
                    Find the best ski conditions near you
                </div>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="px-4 pb-16">
            <div class="max-w-6xl mx-auto">
                <!-- Search Section -->
                <section class="mb-8">
                    <div class="glass-card rounded-2xl p-6 sm:p-8">
                        <h2 class="text-xl font-semibold mb-6 text-slate-200">
                            Where are you skiing from?
                        </h2>
                        
                        <form id="search-form" class="flex flex-col sm:flex-row gap-4">
                            <div class="flex-1">
                                <input 
                                    type="text" 
                                    id="location-input"
                                    class="search-input w-full px-5 py-4 rounded-xl text-white placeholder-slate-400 focus:outline-none text-lg"
                                    placeholder="Enter zip code or city, state (e.g., 80302 or Denver, CO)"
                                    autocomplete="off"
                                    required
                                >
                            </div>
                            
                            <div class="flex gap-4">
                                <select 
                                    id="radius-select"
                                    class="search-input px-5 py-4 rounded-xl text-white focus:outline-none appearance-none cursor-pointer"
                                >
                                    <option value="50">50 mi</option>
                                    <option value="100" selected>100 mi</option>
                                    <option value="150">150 mi</option>
                                    <option value="200">200 mi</option>
                                    <option value="300">300 mi</option>
                                </select>
                                
                                <button 
                                    type="submit"
                                    id="search-btn"
                                    class="btn-primary px-8 py-4 rounded-xl font-semibold text-white flex items-center gap-2"
                                >
                                    <span id="search-text">Search</span>
                                    <div id="search-spinner" class="spinner hidden"></div>
                                </button>
                            </div>
                        </form>
                        
                        <div class="mt-4 flex flex-col sm:flex-row sm:items-center gap-4">
                            <div class="flex items-center gap-4">
                                <span class="text-slate-400 text-sm">Prioritize:</span>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input 
                                        type="radio" 
                                        name="priority"
                                        id="priority-snow"
                                        value="snow"
                                        checked
                                        class="w-4 h-4 border-slate-600 bg-slate-800 text-cyan-500 focus:ring-cyan-500 focus:ring-offset-0"
                                    >
                                    <span class="text-slate-300 text-sm">‚ùÑÔ∏è Snow Quality</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input 
                                        type="radio" 
                                        name="priority"
                                        id="priority-distance"
                                        value="distance"
                                        class="w-4 h-4 border-slate-600 bg-slate-800 text-pink-500 focus:ring-pink-500 focus:ring-offset-0"
                                    >
                                    <span class="text-slate-300 text-sm">üöó Distance</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Error Message -->
                <div id="error-message" class="hidden mb-6">
                    <div class="bg-red-500/20 border border-red-500/50 rounded-xl px-6 py-4 text-red-200">
                        <span id="error-text"></span>
                    </div>
                </div>
                
                <!-- Results Section -->
                <section id="results-section" class="hidden">
                    <!-- Map -->
                    <div class="mb-8">
                        <div id="map"></div>
                    </div>
                    
                    <!-- Results Header -->
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-semibold text-slate-200">
                            <span id="results-count">0</span> Resorts Found
                        </h2>
                        <div id="user-location-display" class="text-slate-400 text-sm">
                        </div>
                    </div>
                    
                    <!-- Resort Cards -->
                    <div id="resort-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Resort cards will be inserted here -->
                    </div>
                </section>
                
                <!-- Empty State -->
                <section id="empty-state" class="text-center py-20">
                    <div class="text-6xl mb-6">üèîÔ∏è</div>
                    <h2 class="text-2xl font-semibold text-slate-300 mb-3">
                        Ready to Find Fresh Powder?
                    </h2>
                    <p class="text-slate-400 max-w-md mx-auto">
                        Enter your location above to discover ski resorts with the best conditions near you.
                    </p>
                </section>
            </div>
        </main>
        
        <!-- Footer -->
        <footer class="py-8 px-4 text-center text-slate-500 text-sm">
            <p>Data from OnTheSnow ‚Ä¢ Updates every 30 minutes</p>
        </footer>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <script>
        // State
        let map = null;
        let markers = [];
        let userMarker = null;
        
        // DOM Elements
        const searchForm = document.getElementById('search-form');
        const locationInput = document.getElementById('location-input');
        const radiusSelect = document.getElementById('radius-select');
        const searchBtn = document.getElementById('search-btn');
        const searchText = document.getElementById('search-text');
        const searchSpinner = document.getElementById('search-spinner');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const resultsSection = document.getElementById('results-section');
        const emptyState = document.getElementById('empty-state');
        const resultsCount = document.getElementById('results-count');
        const userLocationDisplay = document.getElementById('user-location-display');
        const resortList = document.getElementById('resort-list');
        
        // Initialize map
        function initMap(lat, lng) {
            if (map) {
                map.setView([lat, lng], 7);
            } else {
                map = L.map('map').setView([lat, lng], 7);
                
                // Use a darker tile layer
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    subdomains: 'abcd',
                    maxZoom: 19
                }).addTo(map);
            }
        }
        
        // Clear markers
        function clearMarkers() {
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            if (userMarker) {
                map.removeLayer(userMarker);
                userMarker = null;
            }
        }
        
        // Add user marker
        function addUserMarker(lat, lng, query) {
            const icon = L.divIcon({
                className: 'user-marker',
                html: `<div style="
                    width: 24px;
                    height: 24px;
                    background: linear-gradient(135deg, #f472b6, #ec4899);
                    border-radius: 50%;
                    border: 3px solid white;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                "></div>`,
                iconSize: [24, 24],
                iconAnchor: [12, 12],
            });
            
            userMarker = L.marker([lat, lng], { icon })
                .addTo(map)
                .bindPopup(`<div style="padding: 8px; text-align: center;">
                    <div style="font-weight: 600; margin-bottom: 4px;">Your Location</div>
                    <div style="color: #94a3b8; font-size: 12px;">${query}</div>
                </div>`);
        }
        
        // Get marker color based on snow quality score
        function getSnowQualityColor(snowScore) {
            // snowScore is 0-100 (absolute scale)
            // Map to a gradient from dark gray (low) to pure white (high)
            // Linear mapping so 50 score = 50% brightness
            const t = Math.max(0, Math.min(100, snowScore)) / 100;
            
            // Dark gray (low): hsl(0, 0%, 20%)
            // White (high): hsl(0, 0%, 100%)
            const light = 20 + (80 * t); // 20% -> 100%
            
            return `hsl(0, 0%, ${light}%)`;
        }
        
        // Add resort marker
        function addResortMarker(resort) {
            const isOpen = resort.is_open;
            const snowScore = resort.snow_quality_score || 0;
            
            // Use snow quality to determine color saturation
            const color = isOpen 
                ? getSnowQualityColor(snowScore)
                : '#64748b'; // Gray for closed
            
            // Add glow effect for high quality snow
            const glowEffect = snowScore >= 80 
                ? `box-shadow: 0 4px 12px rgba(0,0,0,0.3), 0 0 20px ${color}80;`
                : 'box-shadow: 0 4px 12px rgba(0,0,0,0.3);';
            
            const icon = L.divIcon({
                className: 'resort-marker',
                html: `<div style="
                    width: 32px;
                    height: 32px;
                    background: ${color};
                    border-radius: 50% 50% 50% 0;
                    transform: rotate(-45deg);
                    border: 2px solid white;
                    ${glowEffect}
                    display: flex;
                    align-items: center;
                    justify-content: center;
                "><span style="transform: rotate(45deg); font-size: 14px;">‚õ∑Ô∏è</span></div>`,
                iconSize: [32, 32],
                iconAnchor: [16, 32],
            });
            
            const driveInfo = resort.drive_time 
                ? `üöó ${resort.drive_miles} mi ‚Ä¢ ${resort.drive_time}`
                : `üöó ~${resort.drive_miles} mi`;
            
            const marker = L.marker([resort.latitude, resort.longitude], { icon })
                .addTo(map)
                .bindPopup(`<div style="padding: 12px; min-width: 180px;">
                    <div style="font-weight: 600; font-size: 14px; margin-bottom: 8px;">${resort.name}</div>
                    <div style="color: #94a3b8; font-size: 12px; margin-bottom: 8px;">${resort.state}</div>
                    <div style="font-size: 13px; color: #e2e8f0;">${resort.conditions_summary}</div>
                    <div style="color: #94a3b8; font-size: 12px; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1);">
                        ${driveInfo}
                    </div>
                    <a href="${resort.url}" target="_blank" style="
                        display: block;
                        margin-top: 8px;
                        padding: 6px 12px;
                        background: rgba(56, 189, 248, 0.2);
                        color: #38bdf8;
                        text-align: center;
                        border-radius: 6px;
                        text-decoration: none;
                        font-size: 12px;
                    ">View on OnTheSnow ‚Üí</a>
                </div>`);
            
            markers.push(marker);
        }
        
        // Format duration
        function formatDuration(hours) {
            if (!hours) return '';
            if (hours < 1) {
                return `${Math.round(hours * 60)} min`;
            }
            const h = Math.floor(hours);
            const m = Math.round((hours - h) * 60);
            return m > 0 ? `${h}h ${m}m` : `${h}h`;
        }
        
        // Create resort card HTML
        function createResortCard(resort, index) {
            const isOpen = resort.is_open;
            const hasNewSnow = resort.new_snow_24h && resort.new_snow_24h > 0;
            
            const statusBadge = isOpen
                ? '<span class="text-emerald-400 text-sm font-medium">‚óè Open</span>'
                : '<span class="text-slate-500 text-sm font-medium">‚óè Closed</span>';
            
            const snowBadge = hasNewSnow
                ? `<span class="snow-badge fresh px-3 py-1 rounded-full text-xs font-medium">${resort.new_snow_24h}" new</span>`
                : '';
            
            // Drive time display
            const driveDisplay = resort.drive_time 
                ? `${resort.drive_miles} mi ‚Ä¢ ${resort.drive_time}`
                : `~${resort.drive_miles} mi`;
            
            // Overall score badge with color gradient based on score
            const overallScore = resort.overall_score || 0;
            const scoreColor = overallScore >= 70 ? 'from-emerald-500 to-green-600' 
                             : overallScore >= 50 ? 'from-cyan-500 to-blue-600'
                             : overallScore >= 30 ? 'from-amber-500 to-orange-600'
                             : 'from-slate-500 to-slate-600';
            
            return `
                <div class="resort-card glass-card rounded-2xl p-6 cursor-pointer" onclick="focusResort(${index})">
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <h3 class="text-lg font-semibold text-white mb-1">${resort.name}</h3>
                            <p class="text-slate-400 text-sm">${resort.state}</p>
                        </div>
                        <div class="text-right">
                            <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-gradient-to-r ${scoreColor} text-white text-sm font-bold mb-2">
                                ${overallScore}
                            </div>
                            ${statusBadge}
                            <div class="text-slate-300 text-sm mt-1 mono">üöó ${driveDisplay}</div>
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap gap-2 mb-4">
                        ${resort.base_depth ? `<span class="snow-badge px-3 py-1 rounded-full text-xs font-medium">${resort.base_depth}" base</span>` : ''}
                        ${snowBadge}
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 text-sm mb-4">
                        <div>
                            <div class="text-slate-500 text-xs uppercase tracking-wide mb-1">Trails</div>
                            <div class="text-slate-200">
                                ${resort.trails_open || 0} / ${resort.trails_total || '?'}
                                <span class="text-slate-500">(${resort.trails_percent_open || 0}%)</span>
                            </div>
                        </div>
                        <div>
                            <div class="text-slate-500 text-xs uppercase tracking-wide mb-1">Lifts</div>
                            <div class="text-slate-200">
                                ${resort.lifts_open || 0} / ${resort.lifts_total || '?'}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Score breakdown -->
                    <div class="grid grid-cols-2 gap-4 text-sm pt-3 border-t border-white/10">
                        <div>
                            <div class="text-slate-500 text-xs uppercase tracking-wide mb-1">Snow Score</div>
                            <div class="flex items-center gap-2">
                                <div class="flex-1 h-2 bg-slate-700 rounded-full overflow-hidden">
                                    <div class="h-full rounded-full" style="width: ${resort.snow_quality_score || 0}%; background: linear-gradient(to right, #1a1a1a 0%, #262626 40%, #3d3d3d 60%, #525252 75%, #8a8a8a 90%, #ffffff 100%);"></div>
                                </div>
                                <span class="text-slate-300 text-xs mono">${resort.snow_quality_score || 0}</span>
                            </div>
                        </div>
                        <div>
                            <div class="text-slate-500 text-xs uppercase tracking-wide mb-1">Distance Score</div>
                            <div class="flex items-center gap-2">
                                <div class="flex-1 h-2 bg-slate-700 rounded-full overflow-hidden">
                                    <div class="h-full bg-gradient-to-r from-pink-400 to-rose-500 rounded-full" style="width: ${resort.distance_score || 0}%"></div>
                                </div>
                                <span class="text-slate-300 text-xs mono">${resort.distance_score || 0}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Store resorts for focusing
        let currentResorts = [];
        
        // Focus on a resort on the map
        function focusResort(index) {
            if (currentResorts[index] && map) {
                const resort = currentResorts[index];
                map.setView([resort.latitude, resort.longitude], 10);
                markers[index].openPopup();
            }
        }
        
        // Show loading state
        function setLoading(loading) {
            searchBtn.disabled = loading;
            searchText.textContent = loading ? 'Searching...' : 'Search';
            searchSpinner.classList.toggle('hidden', !loading);
        }
        
        // Show error
        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
            resultsSection.classList.add('hidden');
            emptyState.classList.remove('hidden');
        }
        
        // Hide error
        function hideError() {
            errorMessage.classList.add('hidden');
        }
        
        // Perform search
        async function performSearch() {
            const location = locationInput.value.trim();
            const radius = radiusSelect.value;
            const priority = document.querySelector('input[name="priority"]:checked')?.value || 'snow';
            
            if (!location) {
                showError('Please enter a location');
                return;
            }
            
            hideError();
            setLoading(true);
            
            try {
                const params = new URLSearchParams({
                    location: location,
                    radius: radius,
                    priority: priority,
                });
                
                const response = await fetch(`/api/search/?${params}`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Search failed');
                }
                
                if (data.resorts.length === 0) {
                    showError(`No ski resorts found within ${radius} miles of "${location}". Try increasing the search radius.`);
                    return;
                }
                
                // Store resorts
                currentResorts = data.resorts;
                
                // Update UI
                emptyState.classList.add('hidden');
                resultsSection.classList.remove('hidden');
                resultsCount.textContent = data.count;
                userLocationDisplay.textContent = `within ${radius} mi drive of ${data.user_location.query}`;
                
                // Initialize/update map
                initMap(data.user_location.latitude, data.user_location.longitude);
                clearMarkers();
                
                // Add markers
                addUserMarker(data.user_location.latitude, data.user_location.longitude, data.user_location.query);
                data.resorts.forEach(resort => addResortMarker(resort));
                
                // Fit bounds to show all markers
                if (data.resorts.length > 0) {
                    const allPoints = [
                        [data.user_location.latitude, data.user_location.longitude],
                        ...data.resorts.map(r => [r.latitude, r.longitude])
                    ];
                    map.fitBounds(allPoints, { padding: [50, 50] });
                }
                
                // Render resort cards
                resortList.innerHTML = data.resorts.map((resort, index) => 
                    createResortCard(resort, index)
                ).join('');
                
            } catch (error) {
                console.error('Search error:', error);
                showError(error.message || 'An error occurred while searching. Please try again.');
            } finally {
                setLoading(false);
            }
        }
        
        // Form submit handler
        searchForm.addEventListener('submit', (e) => {
            e.preventDefault();
            performSearch();
        });
        
        // Allow Enter key to submit
        locationInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                performSearch();
            }
        });
    </script>
</body>
</html>

